var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
import { Component, ElementRef, Input, Output, EventEmitter, ChangeDetectionStrategy, ViewEncapsulation, } from '@angular/core';
import { Timer } from './countdown.timer';
import { CountdownConfig } from './countdown.config';
var CountdownComponent = /** @class */ (function () {
    function CountdownComponent(el, timer, cog) {
        this.el = el;
        this.timer = timer;
        this.cog = cog;
        this.frequency = 1000;
        this._notify = {};
        this.hands = [];
        this.left = 0;
        this.paused = false;
        /** 两种情况会触发：时间终止或调用 `stop()` */
        this.stoped = false;
        this.start = new EventEmitter();
        this.finished = new EventEmitter();
        this.notify = new EventEmitter();
        this.event = new EventEmitter();
    }
    /** 开始，当 `demand: false` 时触发 */
    CountdownComponent.prototype.begin = function () {
        this.paused = false;
        this.start.emit();
        this.callEvent('start');
    };
    /** 重新开始 */
    CountdownComponent.prototype.restart = function () {
        if (!this.stoped)
            this.destroy();
        this.init();
        this.callEvent('restart');
    };
    /** 停止 */
    CountdownComponent.prototype.stop = function () {
        if (this.stoped)
            return;
        this.stoped = true;
        this.destroy();
        this.callEvent('stop');
    };
    /** 暂停（限未终止有效） */
    CountdownComponent.prototype.pause = function () {
        if (this.stoped || this.paused)
            return;
        this.paused = true;
        this.callEvent('pause');
    };
    /** 恢复 */
    CountdownComponent.prototype.resume = function () {
        if (this.stoped || !this.paused)
            return;
        this.paused = false;
        this.callEvent('resume');
    };
    CountdownComponent.prototype.callEvent = function (action) {
        this.event.emit({ action: action, left: this.left });
    };
    CountdownComponent.prototype.init = function () {
        var me = this;
        me.config = __assign({}, new CountdownConfig(), me.cog, me.config);
        var el = me.el.nativeElement;
        me.paused = me.config.demand;
        me.stoped = false;
        // 分析markup
        var tmpl = el.innerHTML || me.config.template;
        me.config.varRegular.lastIndex = 0;
        el.innerHTML = tmpl.replace(me.config.varRegular, function (str, type) {
            // 时钟频率校正.
            if (type === 'u' || type === 's-ext')
                me.frequency = 100;
            // 生成hand的markup
            var content = '';
            if (type === 's-ext') {
                me.hands.push({ type: 's' });
                me.hands.push({ type: 'u' });
                content =
                    me.html('', 's', 'handlet') +
                        me.html('.', '', 'digital') +
                        me.html('', 'u', 'handlet');
            }
            else {
                me.hands.push({ type: type });
            }
            return me.html(content, type, 'hand');
        });
        var clock = me.config.clock;
        me.hands.forEach(function (hand) {
            var type = hand.type;
            var base = 100, i;
            hand.node = el.querySelector(".hand-" + type);
            // radix, bits 初始化
            for (i = clock.length - 3; i > -1; i -= 3) {
                if (type === clock[i]) {
                    break;
                }
                base *= clock[i + 1];
            }
            hand.base = base;
            hand.radix = clock[i + 1];
            hand.bits = clock[i + 2];
        });
        me.getLeft();
        me.reflow(0, true);
        // bind reflow to me
        var _reflow = me.reflow;
        me.reflow = function (count) {
            if (count === void 0) { count = 0; }
            return _reflow.apply(me, [count]);
        };
        // 构建 notify
        if (me.config.notify) {
            me.config.notify.forEach(function (time) {
                if (time < 1)
                    throw new Error("the notify config must be a positive integer.");
                time = time * 1000;
                time = time - (time % me.frequency);
                me._notify[time] = true;
            });
        }
        me.timer.add(me.reflow, me.frequency);
        // show
        el.style.display = 'inline';
        this.timer.start();
        return me;
    };
    CountdownComponent.prototype.destroy = function () {
        this.timer.remove(this.reflow);
        return this;
    };
    /**
     * 更新时钟
     */
    CountdownComponent.prototype.reflow = function (count, force) {
        if (count === void 0) { count = 0; }
        if (force === void 0) { force = false; }
        var me = this;
        if (!force && (me.paused || me.stoped))
            return;
        me.left = me.left - me.frequency * count;
        me.hands.forEach(function (hand) {
            hand.lastValue = hand.value;
            hand.value = Math.floor(me.left / hand.base) % hand.radix;
        });
        me.repaint();
        if (me._notify[me.left]) {
            me.notify.emit(me.left);
            me.callEvent('notify');
        }
        if (me.left < 1) {
            me.finished.emit(0);
            me.stoped = true;
            me.callEvent('finished');
            me.destroy();
        }
    };
    /**
     * 重绘时钟
     */
    CountdownComponent.prototype.repaint = function () {
        var me = this;
        if (me.config.repaint) {
            me.config.repaint.apply(me);
            return;
        }
        var content;
        me.hands.forEach(function (hand) {
            if (hand.lastValue !== hand.value) {
                content = '';
                me.toDigitals(hand.value, hand.bits).forEach(function (digital) {
                    content += me.html(digital.toString(), '', 'digital');
                });
                hand.node.innerHTML = content;
            }
        });
    };
    /**
     * 获取倒计时剩余帧数
     */
    CountdownComponent.prototype.getLeft = function () {
        var me = this;
        var left = me.config.leftTime * 1000;
        var end = me.config.stopTime;
        if (!left && end)
            left = end - new Date().getTime();
        me.left = left - (left % me.frequency);
    };
    /**
     * 生成需要的html代码，辅助工具
     */
    CountdownComponent.prototype.html = function (con, className, type) {
        switch (type) {
            case 'hand':
            case 'handlet':
                className = type + ' hand-' + className;
                break;
            case 'digital':
                if (con === '.') {
                    className = type + ' ' + type + '-point ' + className;
                }
                else {
                    className = type + ' ' + type + '-' + con + ' ' + className;
                }
                break;
        }
        return '<span class="' + className + '">' + con + '</span>';
    };
    /**
     * 把值转换为独立的数字形式
     */
    CountdownComponent.prototype.toDigitals = function (value, bits) {
        value = value < 0 ? 0 : value;
        var digitals = [];
        // 把时、分、秒等换算成数字.
        while (bits--) {
            digitals[bits] = value % 10;
            value = Math.floor(value / 10);
        }
        return digitals;
    };
    CountdownComponent.prototype.ngOnInit = function () {
        this.init();
        if (!this.config.demand)
            this.begin();
    };
    CountdownComponent.prototype.ngOnDestroy = function () {
        this.destroy();
    };
    CountdownComponent.prototype.ngOnChanges = function (changes) {
        if (!changes.config.firstChange) {
            this.restart();
        }
    };
    CountdownComponent.decorators = [
        { type: Component, args: [{
                    selector: 'countdown',
                    template: "\n    <ng-content></ng-content>\n  ",
                    host: { '[class.count-down]': 'true' },
                    encapsulation: ViewEncapsulation.None,
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    styles: ["\n      countdown {\n        display: none;\n      }\n    "]
                }] }
    ];
    /** @nocollapse */
    CountdownComponent.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Timer },
        { type: CountdownConfig }
    ]; };
    CountdownComponent.propDecorators = {
        config: [{ type: Input }],
        start: [{ type: Output }],
        finished: [{ type: Output }],
        notify: [{ type: Output }],
        event: [{ type: Output }]
    };
    return CountdownComponent;
}());
export { CountdownComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY291bnRkb3duLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1jb3VudGRvd24vIiwic291cmNlcyI6WyJzcmMvY291bnRkb3duLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLEtBQUssRUFJTCxNQUFNLEVBQ04sWUFBWSxFQUdaLHVCQUF1QixFQUN2QixpQkFBaUIsR0FFbEIsTUFBTSxlQUFlLENBQUM7QUFHdkIsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUVyRDtJQW9DRSw0QkFDVSxFQUFjLEVBQ2QsS0FBWSxFQUNaLEdBQW9CO1FBRnBCLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDZCxVQUFLLEdBQUwsS0FBSyxDQUFPO1FBQ1osUUFBRyxHQUFILEdBQUcsQ0FBaUI7UUF0QnRCLGNBQVMsR0FBRyxJQUFJLENBQUM7UUFDakIsWUFBTyxHQUFRLEVBQUUsQ0FBQztRQUNsQixVQUFLLEdBQVcsRUFBRSxDQUFDO1FBQ25CLFNBQUksR0FBRyxDQUFDLENBQUM7UUFDVCxXQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLCtCQUErQjtRQUN2QixXQUFNLEdBQUcsS0FBSyxDQUFDO1FBS2QsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFM0IsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFOUIsV0FBTSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFNUIsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFvQyxDQUFDO0lBTW5FLENBQUM7SUFFSiwrQkFBK0I7SUFDL0Isa0NBQUssR0FBTDtRQUNFLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFD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LENBQUMsQ0FBQztTQUNoQztRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxxQ0FBUSxHQUFSO1FBQ0UsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1osSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTTtZQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN4QyxDQUFDO0lBRUQsd0NBQVcsR0FBWDtRQUNFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRUQsd0NBQVcsR0FBWCxVQUNFLE9BQTZEO1FBRTdELElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtZQUMvQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDaEI7SUFDSCxDQUFDOztnQkE1UkYsU0FBUyxTQUFDO29CQUNULFFBQVEsRUFBRSxXQUFXO29CQUNyQixRQUFRLEVBQUUscUNBRVQ7b0JBUUQsSUFBSSxFQUFFLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFO29CQUN0QyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsSUFBSTtvQkFDckMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07NkJBUjdDLDREQUlDO2lCQUtKOzs7O2dCQWpDQyxVQUFVO2dCQWVILEtBQUs7Z0JBQ0wsZUFBZTs7O3lCQTJCckIsS0FBSzt3QkFFTCxNQUFNOzJCQUVOLE1BQU07eUJBRU4sTUFBTTt3QkFFTixNQUFNOztJQTRQVCx5QkFBQztDQUFBLEFBN1JELElBNlJDO1NBN1FZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgT25Jbml0LFxuICBTaW1wbGVDaGFuZ2UsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBWaWV3RW5jYXBzdWxhdGlvbixcbiAgSW5qZWN0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgQ29uZmlnLCBIYW5kIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFRpbWVyIH0gZnJvbSAnLi9jb3VudGRvd24udGltZXInO1xuaW1wb3J0IHsgQ291bnRkb3duQ29uZmlnIH0gZnJvbSAnLi9jb3VudGRvd24uY29uZmlnJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY291bnRkb3duJyxcbiAgdGVtcGxhdGU6IGBcbiAgICA8bmctY29udGVudD48L25nLWNvbnRlbnQ+XG4gIGAsXG4gIHN0eWxlczogW1xuICAgIGBcbiAgICAgIGNvdW50ZG93biB7XG4gICAgICAgIGRpc3BsYXk6IG5vbmU7XG4gICAgICB9XG4gICAgYCxcbiAgXSxcbiAgaG9zdDogeyAnW2NsYXNzLmNvdW50LWRvd25dJzogJ3RydWUnIH0sXG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBDb3VudGRvd25Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBmcmVxdWVuY3kgPSAxMDAwO1xuICBwcml2YXRlIF9ub3RpZnk6IGFueSA9IHt9O1xuICBwcml2YXRlIGhhbmRzOiBIYW5kW10gPSBbXTtcbiAgcHJpdmF0ZSBsZWZ0ID0gMDtcbiAgcHJpdmF0ZSBwYXVzZWQgPSBmYWxzZTtcbiAgLyoqIOS4pOenjeaDheWGteS8muinpuWPke+8muaXtumXtOe7iOatouaIluiwg+eUqCBgc3RvcCgpYCAqL1xuICBwcml2YXRlIHN0b3BlZCA9IGZhbHNlO1xuXG4gIEBJbnB1dCgpXG4gIGNvbmZpZzogQ29uZmlnO1xuICBAT3V0cHV0KClcbiAgcmVhZG9ubHkgc3RhcnQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKVxuICByZWFkb25seSBmaW5pc2hlZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpXG4gIHJlYWRvbmx5IG5vdGlmeSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpXG4gIHJlYWRvbmx5IGV2ZW50ID0gbmV3IEV2ZW50RW1pdHRlcjx7IGFjdGlvbjogc3RyaW5nOyBsZWZ0OiBudW1iZXIgfT4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgdGltZXI6IFRpbWVyLFxuICAgIHByaXZhdGUgY29nOiBDb3VudGRvd25Db25maWcsXG4gICkge31cblxuICAvKiog5byA5aeL77yM5b2TIGBkZW1hbmQ6IGZhbHNlYCDml7bop6blj5EgKi9cbiAgYmVnaW4oKSB7XG4gICAgdGhpcy5wYXVzZWQgPSBmYWxzZTtcbiAgICB0aGlzLnN0YXJ0LmVtaXQoKTtcbiAgICB0aGlzLmNhbGxFdmVudCgnc3RhcnQnKTtcbiAgfVxuXG4gIC8qKiDph43mlrDlvIDlp4sgKi9cbiAgcmVzdGFydCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuc3RvcGVkKSB0aGlzLmRlc3Ryb3koKTtcbiAgICB0aGlzLmluaXQoKTtcbiAgICB0aGlzLmNhbGxFdmVudCgncmVzdGFydCcpO1xuICB9XG5cbiAgLyoqIOWBnOatoiAqL1xuICBzdG9wKCkge1xuICAgIGlmICh0aGlzLnN0b3BlZCkgcmV0dXJuO1xuICAgIHRoaXMuc3RvcGVkID0gdHJ1ZTtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICB0aGlzLmNhbGxFdmVudCgnc3RvcCcpO1xuICB9XG5cbiAgLyoqIOaaguWBnO+8iOmZkOacque7iOatouacieaViO+8iSAqL1xuICBwYXVzZSgpIHtcbiAgICBpZiAodGhpcy5zdG9wZWQgfHwgdGhpcy5wYXVzZWQpIHJldHVybjtcbiAgICB0aGlzLnBhdXNlZCA9IHRydWU7XG4gICAgdGhpcy5jYWxsRXZlbnQoJ3BhdXNlJyk7XG4gIH1cblxuICAvKiog5oGi5aSNICovXG4gIHJlc3VtZSgpIHtcbiAgICBpZiAodGhpcy5zdG9wZWQgfHwgIXRoaXMucGF1c2VkKSByZXR1cm47XG4gICAgdGhpcy5wYXVzZWQgPSBmYWxzZTtcbiAgICB0aGlzLmNhbGxFdmVudCgncmVzdW1lJyk7XG4gIH1cblxuICBwcml2YXRlIGNhbGxFdmVudChhY3Rpb246IHN0cmluZykge1xuICAgIHRoaXMuZXZlbnQuZW1pdCh7IGFjdGlvbiwgbGVmdDogdGhpcy5sZWZ0IH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0KCkge1xuICAgIGNvbnN0IG1lID0gdGhpcztcbiAgICBtZS5jb25maWcgPSB7IC4uLm5ldyBDb3VudGRvd25Db25maWcoKSwgLi4ubWUuY29nLCAuLi5tZS5jb25maWcgfTtcbiAgICBjb25zdCBlbCA9IG1lLmVsLm5hdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgbWUucGF1c2VkID0gbWUuY29uZmlnLmRlbWFuZDtcbiAgICBtZS5zdG9wZWQgPSBmYWxzZTtcblxuICAgIC8vIOWIhuaekG1hcmt1cFxuICAgIGNvbnN0IHRtcGwgPSBlbC5pbm5lckhUTUwgfHwgbWUuY29uZmlnLnRlbXBsYXRlO1xuICAgIG1lLmNvbmZpZy52YXJSZWd1bGFyLmxhc3RJbmRleCA9IDA7XG4gICAgZWwuaW5uZXJIVE1MID0gdG1wbC5yZXBsYWNlKFxuICAgICAgbWUuY29uZmlnLnZhclJlZ3VsYXIsXG4gICAgICAoc3RyOiBzdHJpbmcsIHR5cGU6IHN0cmluZykgPT4ge1xuICAgICAgICAvLyDml7bpkp/popHnjofmoKHmraMuXG4gICAgICAgIGlmICh0eXBlID09PSAndScgfHwgdHlwZSA9PT0gJ3MtZXh0JykgbWUuZnJlcXVlbmN5ID0gMTAwO1xuXG4gICAgICAgIC8vIOeUn+aIkGhhbmTnmoRtYXJrdXBcbiAgICAgICAgbGV0IGNvbnRlbnQgPSAnJztcbiAgICAgICAgaWYgKHR5cGUgPT09ICdzLWV4dCcpIHtcbiAgICAgICAgICBtZS5oYW5kcy5wdXNoKHsgdHlwZTogJ3MnIH0pO1xuICAgICAgICAgIG1lLmhhbmRzLnB1c2goeyB0eXBlOiAndScgfSk7XG4gICAgICAgICAgY29udGVudCA9XG4gICAgICAgICAgICBtZS5odG1sKCcnLCAncycsICdoYW5kbGV0JykgK1xuICAgICAgICAgICAgbWUuaHRtbCgnLicsICcnLCAnZGlnaXRhbCcpICtcbiAgICAgICAgICAgIG1lLmh0bWwoJycsICd1JywgJ2hhbmRsZXQnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtZS5oYW5kcy5wdXNoKHsgdHlwZTogdHlwZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtZS5odG1sKGNvbnRlbnQsIHR5cGUsICdoYW5kJyk7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBjb25zdCBjbG9jayA9IG1lLmNvbmZpZy5jbG9jaztcbiAgICBtZS5oYW5kcy5mb3JFYWNoKChoYW5kOiBIYW5kKSA9PiB7XG4gICAgICBjb25zdCB0eXBlID0gaGFuZC50eXBlO1xuICAgICAgbGV0IGJhc2UgPSAxMDAsXG4gICAgICAgIGk6IG51bWJlcjtcblxuICAgICAgaGFuZC5ub2RlID0gZWwucXVlcnlTZWxlY3RvcihgLmhhbmQtJHt0eXBlfWApO1xuICAgICAgLy8gcmFkaXgsIGJpdHMg5Yid5aeL5YyWXG4gICAgICBmb3IgKGkgPSBjbG9jay5sZW5ndGggLSAzOyBpID4gLTE7IGkgLT0gMykge1xuICAgICAgICBpZiAodHlwZSA9PT0gY2xvY2tbaV0pIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGJhc2UgKj0gY2xvY2tbaSArIDFdO1xuICAgICAgfVxuICAgICAgaGFuZC5iYXNlID0gYmFzZTtcbiAgICAgIGhhbmQucmFkaXggPSBjbG9ja1tpICsgMV07XG4gICAgICBoYW5kLmJpdHMgPSBjbG9ja1tpICsgMl07XG4gICAgfSk7XG5cbiAgICBtZS5nZXRMZWZ0KCk7XG4gICAgbWUucmVmbG93KDAsIHRydWUpO1xuXG4gICAgLy8gYmluZCByZWZsb3cgdG8gbWVcbiAgICBjb25zdCBfcmVmbG93ID0gbWUucmVmbG93O1xuICAgIG1lLnJlZmxvdyA9IChjb3VudDogbnVtYmVyID0gMCkgPT4ge1xuICAgICAgcmV0dXJuIF9yZWZsb3cuYXBwbHkobWUsIFtjb3VudF0pO1xuICAgIH07XG5cbiAgICAvLyDmnoTlu7ogbm90aWZ5XG4gICAgaWYgKG1lLmNvbmZpZy5ub3RpZnkpIHtcbiAgICAgIG1lLmNvbmZpZy5ub3RpZnkuZm9yRWFjaCgodGltZTogbnVtYmVyKSA9PiB7XG4gICAgICAgIGlmICh0aW1lIDwgMSlcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHRoZSBub3RpZnkgY29uZmlnIG11c3QgYmUgYSBwb3NpdGl2ZSBpbnRlZ2VyLmApO1xuICAgICAgICB0aW1lID0gdGltZSAqIDEwMDA7XG4gICAgICAgIHRpbWUgPSB0aW1lIC0gKHRpbWUgJSBtZS5mcmVxdWVuY3kpO1xuICAgICAgICBtZS5fbm90aWZ5W3RpbWVdID0gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIG1lLnRpbWVyLmFkZChtZS5yZWZsb3csIG1lLmZyZXF1ZW5jeSk7XG4gICAgLy8gc2hvd1xuICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnaW5saW5lJztcblxuICAgIHRoaXMudGltZXIuc3RhcnQoKTtcblxuICAgIHJldHVybiBtZTtcbiAgfVxuXG4gIHByaXZhdGUgZGVzdHJveSgpIHtcbiAgICB0aGlzLnRpbWVyLnJlbW92ZSh0aGlzLnJlZmxvdyk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICog5pu05paw5pe26ZKfXG4gICAqL1xuICBwcml2YXRlIHJlZmxvdyhjb3VudDogbnVtYmVyID0gMCwgZm9yY2U6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xuICAgIGNvbnN0IG1lID0gdGhpcztcbiAgICBpZiAoIWZvcmNlICYmIChtZS5wYXVzZWQgfHwgbWUuc3RvcGVkKSkgcmV0dXJuO1xuICAgIG1lLmxlZnQgPSBtZS5sZWZ0IC0gbWUuZnJlcXVlbmN5ICogY291bnQ7XG5cbiAgICBtZS5oYW5kcy5mb3JFYWNoKChoYW5kOiBIYW5kKSA9PiB7XG4gICAgICBoYW5kLmxhc3RWYWx1ZSA9IGhhbmQudmFsdWU7XG4gICAgICBoYW5kLnZhbHVlID0gTWF0aC5mbG9vcihtZS5sZWZ0IC8gaGFuZC5iYXNlKSAlIGhhbmQucmFkaXg7XG4gICAgfSk7XG5cbiAgICBtZS5yZXBhaW50KCk7XG5cbiAgICBpZiAobWUuX25vdGlmeVttZS5sZWZ0XSkge1xuICAgICAgbWUubm90aWZ5LmVtaXQobWUubGVmdCk7XG4gICAgICBtZS5jYWxsRXZlbnQoJ25vdGlmeScpO1xuICAgIH1cblxuICAgIGlmIChtZS5sZWZ0IDwgMSkge1xuICAgICAgbWUuZmluaXNoZWQuZW1pdCgwKTtcbiAgICAgIG1lLnN0b3BlZCA9IHRydWU7XG4gICAgICBtZS5jYWxsRXZlbnQoJ2ZpbmlzaGVkJyk7XG4gICAgICBtZS5kZXN0cm95KCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOmHjee7mOaXtumSn1xuICAgKi9cbiAgcHJpdmF0ZSByZXBhaW50KCk6IHZvaWQge1xuICAgIGNvbnN0IG1lID0gdGhpcztcbiAgICBpZiAobWUuY29uZmlnLnJlcGFpbnQpIHtcbiAgICAgIG1lLmNvbmZpZy5yZXBhaW50LmFwcGx5KG1lKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgY29udGVudDogc3RyaW5nO1xuXG4gICAgbWUuaGFuZHMuZm9yRWFjaCgoaGFuZDogSGFuZCkgPT4ge1xuICAgICAgaWYgKGhhbmQubGFzdFZhbHVlICE9PSBoYW5kLnZhbHVlKSB7XG4gICAgICAgIGNvbnRlbnQgPSAnJztcblxuICAgICAgICBtZS50b0RpZ2l0YWxzKGhhbmQudmFsdWUsIGhhbmQuYml0cykuZm9yRWFjaCgoZGlnaXRhbDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgY29udGVudCArPSBtZS5odG1sKGRpZ2l0YWwudG9TdHJpbmcoKSwgJycsICdkaWdpdGFsJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGhhbmQubm9kZS5pbm5lckhUTUwgPSBjb250ZW50O1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluWAkuiuoeaXtuWJqeS9meW4p+aVsFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRMZWZ0KCk6IHZvaWQge1xuICAgIGNvbnN0IG1lID0gdGhpcztcbiAgICBsZXQgbGVmdDogbnVtYmVyID0gbWUuY29uZmlnLmxlZnRUaW1lICogMTAwMDtcbiAgICBjb25zdCBlbmQ6IG51bWJlciA9IG1lLmNvbmZpZy5zdG9wVGltZTtcblxuICAgIGlmICghbGVmdCAmJiBlbmQpIGxlZnQgPSBlbmQgLSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcblxuICAgIG1lLmxlZnQgPSBsZWZ0IC0gKGxlZnQgJSBtZS5mcmVxdWVuY3kpO1xuICB9XG5cbiAgLyoqXG4gICAqIOeUn+aIkOmcgOimgeeahGh0bWzku6PnoIHvvIzovoXliqnlt6XlhbdcbiAgICovXG4gIHByaXZhdGUgaHRtbChjb246IHN0cmluZywgY2xhc3NOYW1lOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlICdoYW5kJzpcbiAgICAgIGNhc2UgJ2hhbmRsZXQnOlxuICAgICAgICBjbGFzc05hbWUgPSB0eXBlICsgJyBoYW5kLScgKyBjbGFzc05hbWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZGlnaXRhbCc6XG4gICAgICAgIGlmIChjb24gPT09ICcuJykge1xuICAgICAgICAgIGNsYXNzTmFtZSA9IHR5cGUgKyAnICcgKyB0eXBlICsgJy1wb2ludCAnICsgY2xhc3NOYW1lO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNsYXNzTmFtZSA9IHR5cGUgKyAnICcgKyB0eXBlICsgJy0nICsgY29uICsgJyAnICsgY2xhc3NOYW1lO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwiJyArIGNsYXNzTmFtZSArICdcIj4nICsgY29uICsgJzwvc3Bhbj4nO1xuICB9XG5cbiAgLyoqXG4gICAqIOaKiuWAvOi9rOaNouS4uueLrOeri+eahOaVsOWtl+W9ouW8j1xuICAgKi9cbiAgcHJpdmF0ZSB0b0RpZ2l0YWxzKHZhbHVlOiBudW1iZXIsIGJpdHM6IG51bWJlcik6IG51bWJlcltdIHtcbiAgICB2YWx1ZSA9IHZhbHVlIDwgMCA/IDAgOiB2YWx1ZTtcbiAgICBjb25zdCBkaWdpdGFscyA9IFtdO1xuICAgIC8vIOaKiuaXtuOAgeWIhuOAgeenkuetieaNoueul+aIkOaVsOWtly5cbiAgICB3aGlsZSAoYml0cy0tKSB7XG4gICAgICBkaWdpdGFsc1tiaXRzXSA9IHZhbHVlICUgMTA7XG4gICAgICB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUgLyAxMCk7XG4gICAgfVxuICAgIHJldHVybiBkaWdpdGFscztcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuaW5pdCgpO1xuICAgIGlmICghdGhpcy5jb25maWcuZGVtYW5kKSB0aGlzLmJlZ2luKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKFxuICAgIGNoYW5nZXM6IHsgW1AgaW4ga2V5b2YgdGhpc10/OiBTaW1wbGVDaGFuZ2UgfSAmIFNpbXBsZUNoYW5nZXMsXG4gICk6IHZvaWQge1xuICAgIGlmICghY2hhbmdlcy5jb25maWcuZmlyc3RDaGFuZ2UpIHtcbiAgICAgIHRoaXMucmVzdGFydCgpO1xuICAgIH1cbiAgfVxufVxuIl19