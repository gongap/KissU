import { Component, ElementRef, Input, Output, EventEmitter, ChangeDetectionStrategy, ViewEncapsulation, } from '@angular/core';
import { Timer } from './countdown.timer';
import { CountdownConfig } from './countdown.config';
export class CountdownComponent {
    constructor(el, timer, cog) {
        this.el = el;
        this.timer = timer;
        this.cog = cog;
        this.frequency = 1000;
        this._notify = {};
        this.hands = [];
        this.left = 0;
        this.paused = false;
        /** 两种情况会触发：时间终止或调用 `stop()` */
        this.stoped = false;
        this.start = new EventEmitter();
        this.finished = new EventEmitter();
        this.notify = new EventEmitter();
        this.event = new EventEmitter();
    }
    /** 开始，当 `demand: false` 时触发 */
    begin() {
        this.paused = false;
        this.start.emit();
        this.callEvent('start');
    }
    /** 重新开始 */
    restart() {
        if (!this.stoped)
            this.destroy();
        this.init();
        this.callEvent('restart');
    }
    /** 停止 */
    stop() {
        if (this.stoped)
            return;
        this.stoped = true;
        this.destroy();
        this.callEvent('stop');
    }
    /** 暂停（限未终止有效） */
    pause() {
        if (this.stoped || this.paused)
            return;
        this.paused = true;
        this.callEvent('pause');
    }
    /** 恢复 */
    resume() {
        if (this.stoped || !this.paused)
            return;
        this.paused = false;
        this.callEvent('resume');
    }
    callEvent(action) {
        this.event.emit({ action, left: this.left });
    }
    init() {
        const me = this;
        me.config = Object.assign({}, new CountdownConfig(), me.cog, me.config);
        const el = me.el.nativeElement;
        me.paused = me.config.demand;
        me.stoped = false;
        // 分析markup
        const tmpl = el.innerHTML || me.config.template;
        me.config.varRegular.lastIndex = 0;
        el.innerHTML = tmpl.replace(me.config.varRegular, (str, type) => {
            // 时钟频率校正.
            if (type === 'u' || type === 's-ext')
                me.frequency = 100;
            // 生成hand的markup
            let content = '';
            if (type === 's-ext') {
                me.hands.push({ type: 's' });
                me.hands.push({ type: 'u' });
                content =
                    me.html('', 's', 'handlet') +
                        me.html('.', '', 'digital') +
                        me.html('', 'u', 'handlet');
            }
            else {
                me.hands.push({ type: type });
            }
            return me.html(content, type, 'hand');
        });
        const clock = me.config.clock;
        me.hands.forEach((hand) => {
            const type = hand.type;
            let base = 100, i;
            hand.node = el.querySelector(`.hand-${type}`);
            // radix, bits 初始化
            for (i = clock.length - 3; i > -1; i -= 3) {
                if (type === clock[i]) {
                    break;
                }
                base *= clock[i + 1];
            }
            hand.base = base;
            hand.radix = clock[i + 1];
            hand.bits = clock[i + 2];
        });
        me.getLeft();
        me.reflow(0, true);
        // bind reflow to me
        const _reflow = me.reflow;
        me.reflow = (count = 0) => {
            return _reflow.apply(me, [count]);
        };
        // 构建 notify
        if (me.config.notify) {
            me.config.notify.forEach((time) => {
                if (time < 1)
                    throw new Error(`the notify config must be a positive integer.`);
                time = time * 1000;
                time = time - (time % me.frequency);
                me._notify[time] = true;
            });
        }
        me.timer.add(me.reflow, me.frequency);
        // show
        el.style.display = 'inline';
        this.timer.start();
        return me;
    }
    destroy() {
        this.timer.remove(this.reflow);
        return this;
    }
    /**
     * 更新时钟
     */
    reflow(count = 0, force = false) {
        const me = this;
        if (!force && (me.paused || me.stoped))
            return;
        me.left = me.left - me.frequency * count;
        me.hands.forEach((hand) => {
            hand.lastValue = hand.value;
            hand.value = Math.floor(me.left / hand.base) % hand.radix;
        });
        me.repaint();
        if (me._notify[me.left]) {
            me.notify.emit(me.left);
            me.callEvent('notify');
        }
        if (me.left < 1) {
            me.finished.emit(0);
            me.stoped = true;
            me.callEvent('finished');
            me.destroy();
        }
    }
    /**
     * 重绘时钟
     */
    repaint() {
        const me = this;
        if (me.config.repaint) {
            me.config.repaint.apply(me);
            return;
        }
        let content;
        me.hands.forEach((hand) => {
            if (hand.lastValue !== hand.value) {
                content = '';
                me.toDigitals(hand.value, hand.bits).forEach((digital) => {
                    content += me.html(digital.toString(), '', 'digital');
                });
                hand.node.innerHTML = content;
            }
        });
    }
    /**
     * 获取倒计时剩余帧数
     */
    getLeft() {
        const me = this;
        let left = me.config.leftTime * 1000;
        const end = me.config.stopTime;
        if (!left && end)
            left = end - new Date().getTime();
        me.left = left - (left % me.frequency);
    }
    /**
     * 生成需要的html代码，辅助工具
     */
    html(con, className, type) {
        switch (type) {
            case 'hand':
            case 'handlet':
                className = type + ' hand-' + className;
                break;
            case 'digital':
                if (con === '.') {
                    className = type + ' ' + type + '-point ' + className;
                }
                else {
                    className = type + ' ' + type + '-' + con + ' ' + className;
                }
                break;
        }
        return '<span class="' + className + '">' + con + '</span>';
    }
    /**
     * 把值转换为独立的数字形式
     */
    toDigitals(value, bits) {
        value = value < 0 ? 0 : value;
        const digitals = [];
        // 把时、分、秒等换算成数字.
        while (bits--) {
            digitals[bits] = value % 10;
            value = Math.floor(value / 10);
        }
        return digitals;
    }
    ngOnInit() {
        this.init();
        if (!this.config.demand)
            this.begin();
    }
    ngOnDestroy() {
        this.destroy();
    }
    ngOnChanges(changes) {
        if (!changes.config.firstChange) {
            this.restart();
        }
    }
}
CountdownComponent.decorators = [
    { type: Component, args: [{
                selector: 'countdown',
                template: `
    <ng-content></ng-content>
  `,
                host: { '[class.count-down]': 'true' },
                encapsulation: ViewEncapsulation.None,
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [`
      countdown {
        display: none;
      }
    `]
            }] }
];
/** @nocollapse */
CountdownComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Timer },
    { type: CountdownConfig }
];
CountdownComponent.propDecorators = {
    config: [{ type: Input }],
    start: [{ type: Output }],
    finished: [{ type: Output }],
    notify: [{ type: Output }],
    event: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY291bnRkb3duLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1jb3VudGRvd24vIiwic291cmNlcyI6WyJzcmMvY291bnRkb3duLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFVBQVUsRUFDVixLQUFLLEVBSUwsTUFBTSxFQUNOLFlBQVksRUFHWix1QkFBdUIsRUFDdkIsaUJBQWlCLEdBRWxCLE1BQU0sZUFBZSxDQUFDO0FBR3ZCLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFrQnJELE1BQU0sT0FBTyxrQkFBa0I7SUFvQjdCLFlBQ1UsRUFBYyxFQUNkLEtBQVksRUFDWixHQUFvQjtRQUZwQixPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQ2QsVUFBSyxHQUFMLEtBQUssQ0FBTztRQUNaLFFBQUcsR0FBSCxHQUFHLENBQWlCO1FBdEJ0QixjQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLFlBQU8sR0FBUSxFQUFFLENBQUM7UUFDbEIsVUFBSyxHQUFXLEVBQUUsQ0FBQztRQUNuQixTQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ1QsV0FBTSxHQUFHLEtBQUssQ0FBQztRQUN2QiwrQkFBK0I7UUFDdkIsV0FBTSxHQUFHLEtBQUssQ0FBQztRQUtkLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRTNCLGFBQVEsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRTlCLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRTVCLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBb0MsQ0FBQztJQU1uRSxDQUFDO0lBRUosK0JBQStCO0lBQy9CLEtBQUs7UUFDSCxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1FB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UUFDTixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDWixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNO1lBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFFRCxXQUFXLENBQ1QsT0FBNkQ7UUFFN0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFO1lBQy9CLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNoQjtJQUNILENBQUM7OztZQTVSRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLFdBQVc7Z0JBQ3JCLFFBQVEsRUFBRTs7R0FFVDtnQkFRRCxJQUFJLEVBQUUsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUU7Z0JBQ3RDLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJO2dCQUNyQyxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTt5QkFSN0M7Ozs7S0FJQzthQUtKOzs7O1lBakNDLFVBQVU7WUFlSCxLQUFLO1lBQ0wsZUFBZTs7O3FCQTJCckIsS0FBSztvQkFFTCxNQUFNO3VCQUVOLE1BQU07cUJBRU4sTUFBTTtvQkFFTixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBTaW1wbGVDaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBPbkluaXQsXG4gIFNpbXBsZUNoYW5nZSxcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxuICBJbmplY3QsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBDb25maWcsIEhhbmQgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgVGltZXIgfSBmcm9tICcuL2NvdW50ZG93bi50aW1lcic7XG5pbXBvcnQgeyBDb3VudGRvd25Db25maWcgfSBmcm9tICcuL2NvdW50ZG93bi5jb25maWcnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjb3VudGRvd24nLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgYCxcbiAgc3R5bGVzOiBbXG4gICAgYFxuICAgICAgY291bnRkb3duIHtcbiAgICAgICAgZGlzcGxheTogbm9uZTtcbiAgICAgIH1cbiAgICBgLFxuICBdLFxuICBob3N0OiB7ICdbY2xhc3MuY291bnQtZG93bl0nOiAndHJ1ZScgfSxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIENvdW50ZG93bkNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGZyZXF1ZW5jeSA9IDEwMDA7XG4gIHByaXZhdGUgX25vdGlmeTogYW55ID0ge307XG4gIHByaXZhdGUgaGFuZHM6IEhhbmRbXSA9IFtdO1xuICBwcml2YXRlIGxlZnQgPSAwO1xuICBwcml2YXRlIHBhdXNlZCA9IGZhbHNlO1xuICAvKiog5Lik56eN5oOF5Ya15Lya6Kem5Y+R77ya5pe26Ze057uI5q2i5oiW6LCD55SoIGBzdG9wKClgICovXG4gIHByaXZhdGUgc3RvcGVkID0gZmFsc2U7XG5cbiAgQElucHV0KClcbiAgY29uZmlnOiBDb25maWc7XG4gIEBPdXRwdXQoKVxuICByZWFkb25seSBzdGFydCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpXG4gIHJlYWRvbmx5IGZpbmlzaGVkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KClcbiAgcmVhZG9ubHkgbm90aWZ5ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KClcbiAgcmVhZG9ubHkgZXZlbnQgPSBuZXcgRXZlbnRFbWl0dGVyPHsgYWN0aW9uOiBzdHJpbmc7IGxlZnQ6IG51bWJlciB9PigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSB0aW1lcjogVGltZXIsXG4gICAgcHJpdmF0ZSBjb2c6IENvdW50ZG93bkNvbmZpZyxcbiAgKSB7fVxuXG4gIC8qKiDlvIDlp4vvvIzlvZMgYGRlbWFuZDogZmFsc2VgIOaXtuinpuWPkSAqL1xuICBiZWdpbigpIHtcbiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlO1xuICAgIHRoaXMuc3RhcnQuZW1pdCgpO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdzdGFydCcpO1xuICB9XG5cbiAgLyoqIOmHjeaWsOW8gOWniyAqL1xuICByZXN0YXJ0KCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5zdG9wZWQpIHRoaXMuZGVzdHJveSgpO1xuICAgIHRoaXMuaW5pdCgpO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdyZXN0YXJ0Jyk7XG4gIH1cblxuICAvKiog5YGc5q2iICovXG4gIHN0b3AoKSB7XG4gICAgaWYgKHRoaXMuc3RvcGVkKSByZXR1cm47XG4gICAgdGhpcy5zdG9wZWQgPSB0cnVlO1xuICAgIHRoaXMuZGVzdHJveSgpO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdzdG9wJyk7XG4gIH1cblxuICAvKiog5pqC5YGc77yI6ZmQ5pyq57uI5q2i5pyJ5pWI77yJICovXG4gIHBhdXNlKCkge1xuICAgIGlmICh0aGlzLnN0b3BlZCB8fCB0aGlzLnBhdXNlZCkgcmV0dXJuO1xuICAgIHRoaXMucGF1c2VkID0gdHJ1ZTtcbiAgICB0aGlzLmNhbGxFdmVudCgncGF1c2UnKTtcbiAgfVxuXG4gIC8qKiDmgaLlpI0gKi9cbiAgcmVzdW1lKCkge1xuICAgIGlmICh0aGlzLnN0b3BlZCB8fCAhdGhpcy5wYXVzZWQpIHJldHVybjtcbiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlO1xuICAgIHRoaXMuY2FsbEV2ZW50KCdyZXN1bWUnKTtcbiAgfVxuXG4gIHByaXZhdGUgY2FsbEV2ZW50KGFjdGlvbjogc3RyaW5nKSB7XG4gICAgdGhpcy5ldmVudC5lbWl0KHsgYWN0aW9uLCBsZWZ0OiB0aGlzLmxlZnQgfSk7XG4gIH1cblxuICBwcml2YXRlIGluaXQoKSB7XG4gICAgY29uc3QgbWUgPSB0aGlzO1xuICAgIG1lLmNvbmZpZyA9IHsgLi4ubmV3IENvdW50ZG93bkNvbmZpZygpLCAuLi5tZS5jb2csIC4uLm1lLmNvbmZpZyB9O1xuICAgIGNvbnN0IGVsID0gbWUuZWwubmF0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudDtcbiAgICBtZS5wYXVzZWQgPSBtZS5jb25maWcuZGVtYW5kO1xuICAgIG1lLnN0b3BlZCA9IGZhbHNlO1xuXG4gICAgLy8g5YiG5p6QbWFya3VwXG4gICAgY29uc3QgdG1wbCA9IGVsLmlubmVySFRNTCB8fCBtZS5jb25maWcudGVtcGxhdGU7XG4gICAgbWUuY29uZmlnLnZhclJlZ3VsYXIubGFzdEluZGV4ID0gMDtcbiAgICBlbC5pbm5lckhUTUwgPSB0bXBsLnJlcGxhY2UoXG4gICAgICBtZS5jb25maWcudmFyUmVndWxhcixcbiAgICAgIChzdHI6IHN0cmluZywgdHlwZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIC8vIOaXtumSn+mikeeOh+agoeatoy5cbiAgICAgICAgaWYgKHR5cGUgPT09ICd1JyB8fCB0eXBlID09PSAncy1leHQnKSBtZS5mcmVxdWVuY3kgPSAxMDA7XG5cbiAgICAgICAgLy8g55Sf5oiQaGFuZOeahG1hcmt1cFxuICAgICAgICBsZXQgY29udGVudCA9ICcnO1xuICAgICAgICBpZiAodHlwZSA9PT0gJ3MtZXh0Jykge1xuICAgICAgICAgIG1lLmhhbmRzLnB1c2goeyB0eXBlOiAncycgfSk7XG4gICAgICAgICAgbWUuaGFuZHMucHVzaCh7IHR5cGU6ICd1JyB9KTtcbiAgICAgICAgICBjb250ZW50ID1cbiAgICAgICAgICAgIG1lLmh0bWwoJycsICdzJywgJ2hhbmRsZXQnKSArXG4gICAgICAgICAgICBtZS5odG1sKCcuJywgJycsICdkaWdpdGFsJykgK1xuICAgICAgICAgICAgbWUuaHRtbCgnJywgJ3UnLCAnaGFuZGxldCcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG1lLmhhbmRzLnB1c2goeyB0eXBlOiB0eXBlIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1lLmh0bWwoY29udGVudCwgdHlwZSwgJ2hhbmQnKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbnN0IGNsb2NrID0gbWUuY29uZmlnLmNsb2NrO1xuICAgIG1lLmhhbmRzLmZvckVhY2goKGhhbmQ6IEhhbmQpID0+IHtcbiAgICAgIGNvbnN0IHR5cGUgPSBoYW5kLnR5cGU7XG4gICAgICBsZXQgYmFzZSA9IDEwMCxcbiAgICAgICAgaTogbnVtYmVyO1xuXG4gICAgICBoYW5kLm5vZGUgPSBlbC5xdWVyeVNlbGVjdG9yKGAuaGFuZC0ke3R5cGV9YCk7XG4gICAgICAvLyByYWRpeCwgYml0cyDliJ3lp4vljJZcbiAgICAgIGZvciAoaSA9IGNsb2NrLmxlbmd0aCAtIDM7IGkgPiAtMTsgaSAtPSAzKSB7XG4gICAgICAgIGlmICh0eXBlID09PSBjbG9ja1tpXSkge1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgYmFzZSAqPSBjbG9ja1tpICsgMV07XG4gICAgICB9XG4gICAgICBoYW5kLmJhc2UgPSBiYXNlO1xuICAgICAgaGFuZC5yYWRpeCA9IGNsb2NrW2kgKyAxXTtcbiAgICAgIGhhbmQuYml0cyA9IGNsb2NrW2kgKyAyXTtcbiAgICB9KTtcblxuICAgIG1lLmdldExlZnQoKTtcbiAgICBtZS5yZWZsb3coMCwgdHJ1ZSk7XG5cbiAgICAvLyBiaW5kIHJlZmxvdyB0byBtZVxuICAgIGNvbnN0IF9yZWZsb3cgPSBtZS5yZWZsb3c7XG4gICAgbWUucmVmbG93ID0gKGNvdW50OiBudW1iZXIgPSAwKSA9PiB7XG4gICAgICByZXR1cm4gX3JlZmxvdy5hcHBseShtZSwgW2NvdW50XSk7XG4gICAgfTtcblxuICAgIC8vIOaehOW7uiBub3RpZnlcbiAgICBpZiAobWUuY29uZmlnLm5vdGlmeSkge1xuICAgICAgbWUuY29uZmlnLm5vdGlmeS5mb3JFYWNoKCh0aW1lOiBudW1iZXIpID0+IHtcbiAgICAgICAgaWYgKHRpbWUgPCAxKVxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdGhlIG5vdGlmeSBjb25maWcgbXVzdCBiZSBhIHBvc2l0aXZlIGludGVnZXIuYCk7XG4gICAgICAgIHRpbWUgPSB0aW1lICogMTAwMDtcbiAgICAgICAgdGltZSA9IHRpbWUgLSAodGltZSAlIG1lLmZyZXF1ZW5jeSk7XG4gICAgICAgIG1lLl9ub3RpZnlbdGltZV0gPSB0cnVlO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbWUudGltZXIuYWRkKG1lLnJlZmxvdywgbWUuZnJlcXVlbmN5KTtcbiAgICAvLyBzaG93XG4gICAgZWwuc3R5bGUuZGlzcGxheSA9ICdpbmxpbmUnO1xuXG4gICAgdGhpcy50aW1lci5zdGFydCgpO1xuXG4gICAgcmV0dXJuIG1lO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95KCkge1xuICAgIHRoaXMudGltZXIucmVtb3ZlKHRoaXMucmVmbG93KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiDmm7TmlrDml7bpkp9cbiAgICovXG4gIHByaXZhdGUgcmVmbG93KGNvdW50OiBudW1iZXIgPSAwLCBmb3JjZTogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XG4gICAgY29uc3QgbWUgPSB0aGlzO1xuICAgIGlmICghZm9yY2UgJiYgKG1lLnBhdXNlZCB8fCBtZS5zdG9wZWQpKSByZXR1cm47XG4gICAgbWUubGVmdCA9IG1lLmxlZnQgLSBtZS5mcmVxdWVuY3kgKiBjb3VudDtcblxuICAgIG1lLmhhbmRzLmZvckVhY2goKGhhbmQ6IEhhbmQpID0+IHtcbiAgICAgIGhhbmQubGFzdFZhbHVlID0gaGFuZC52YWx1ZTtcbiAgICAgIGhhbmQudmFsdWUgPSBNYXRoLmZsb29yKG1lLmxlZnQgLyBoYW5kLmJhc2UpICUgaGFuZC5yYWRpeDtcbiAgICB9KTtcblxuICAgIG1lLnJlcGFpbnQoKTtcblxuICAgIGlmIChtZS5fbm90aWZ5W21lLmxlZnRdKSB7XG4gICAgICBtZS5ub3RpZnkuZW1pdChtZS5sZWZ0KTtcbiAgICAgIG1lLmNhbGxFdmVudCgnbm90aWZ5Jyk7XG4gICAgfVxuXG4gICAgaWYgKG1lLmxlZnQgPCAxKSB7XG4gICAgICBtZS5maW5pc2hlZC5lbWl0KDApO1xuICAgICAgbWUuc3RvcGVkID0gdHJ1ZTtcbiAgICAgIG1lLmNhbGxFdmVudCgnZmluaXNoZWQnKTtcbiAgICAgIG1lLmRlc3Ryb3koKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6YeN57uY5pe26ZKfXG4gICAqL1xuICBwcml2YXRlIHJlcGFpbnQoKTogdm9pZCB7XG4gICAgY29uc3QgbWUgPSB0aGlzO1xuICAgIGlmIChtZS5jb25maWcucmVwYWludCkge1xuICAgICAgbWUuY29uZmlnLnJlcGFpbnQuYXBwbHkobWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBjb250ZW50OiBzdHJpbmc7XG5cbiAgICBtZS5oYW5kcy5mb3JFYWNoKChoYW5kOiBIYW5kKSA9PiB7XG4gICAgICBpZiAoaGFuZC5sYXN0VmFsdWUgIT09IGhhbmQudmFsdWUpIHtcbiAgICAgICAgY29udGVudCA9ICcnO1xuXG4gICAgICAgIG1lLnRvRGlnaXRhbHMoaGFuZC52YWx1ZSwgaGFuZC5iaXRzKS5mb3JFYWNoKChkaWdpdGFsOiBudW1iZXIpID0+IHtcbiAgICAgICAgICBjb250ZW50ICs9IG1lLmh0bWwoZGlnaXRhbC50b1N0cmluZygpLCAnJywgJ2RpZ2l0YWwnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaGFuZC5ub2RlLmlubmVySFRNTCA9IGNvbnRlbnQ7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5YCS6K6h5pe25Ymp5L2Z5bin5pWwXG4gICAqL1xuICBwcml2YXRlIGdldExlZnQoKTogdm9pZCB7XG4gICAgY29uc3QgbWUgPSB0aGlzO1xuICAgIGxldCBsZWZ0OiBudW1iZXIgPSBtZS5jb25maWcubGVmdFRpbWUgKiAxMDAwO1xuICAgIGNvbnN0IGVuZDogbnVtYmVyID0gbWUuY29uZmlnLnN0b3BUaW1lO1xuXG4gICAgaWYgKCFsZWZ0ICYmIGVuZCkgbGVmdCA9IGVuZCAtIG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG4gICAgbWUubGVmdCA9IGxlZnQgLSAobGVmdCAlIG1lLmZyZXF1ZW5jeSk7XG4gIH1cblxuICAvKipcbiAgICog55Sf5oiQ6ZyA6KaB55qEaHRtbOS7o+egge+8jOi+heWKqeW3peWFt1xuICAgKi9cbiAgcHJpdmF0ZSBodG1sKGNvbjogc3RyaW5nLCBjbGFzc05hbWU6IHN0cmluZywgdHlwZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgJ2hhbmQnOlxuICAgICAgY2FzZSAnaGFuZGxldCc6XG4gICAgICAgIGNsYXNzTmFtZSA9IHR5cGUgKyAnIGhhbmQtJyArIGNsYXNzTmFtZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkaWdpdGFsJzpcbiAgICAgICAgaWYgKGNvbiA9PT0gJy4nKSB7XG4gICAgICAgICAgY2xhc3NOYW1lID0gdHlwZSArICcgJyArIHR5cGUgKyAnLXBvaW50ICcgKyBjbGFzc05hbWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY2xhc3NOYW1lID0gdHlwZSArICcgJyArIHR5cGUgKyAnLScgKyBjb24gKyAnICcgKyBjbGFzc05hbWU7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCInICsgY2xhc3NOYW1lICsgJ1wiPicgKyBjb24gKyAnPC9zcGFuPic7XG4gIH1cblxuICAvKipcbiAgICog5oqK5YC86L2s5o2i5Li654us56uL55qE5pWw5a2X5b2i5byPXG4gICAqL1xuICBwcml2YXRlIHRvRGlnaXRhbHModmFsdWU6IG51bWJlciwgYml0czogbnVtYmVyKTogbnVtYmVyW10ge1xuICAgIHZhbHVlID0gdmFsdWUgPCAwID8gMCA6IHZhbHVlO1xuICAgIGNvbnN0IGRpZ2l0YWxzID0gW107XG4gICAgLy8g5oqK5pe244CB5YiG44CB56eS562J5o2i566X5oiQ5pWw5a2XLlxuICAgIHdoaWxlIChiaXRzLS0pIHtcbiAgICAgIGRpZ2l0YWxzW2JpdHNdID0gdmFsdWUgJSAxMDtcbiAgICAgIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSAvIDEwKTtcbiAgICB9XG4gICAgcmV0dXJuIGRpZ2l0YWxzO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5pbml0KCk7XG4gICAgaWYgKCF0aGlzLmNvbmZpZy5kZW1hbmQpIHRoaXMuYmVnaW4oKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZGVzdHJveSgpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoXG4gICAgY2hhbmdlczogeyBbUCBpbiBrZXlvZiB0aGlzXT86IFNpbXBsZUNoYW5nZSB9ICYgU2ltcGxlQ2hhbmdlcyxcbiAgKTogdm9pZCB7XG4gICAgaWYgKCFjaGFuZ2VzLmNvbmZpZy5maXJzdENoYW5nZSkge1xuICAgICAgdGhpcy5yZXN0YXJ0KCk7XG4gICAgfVxuICB9XG59XG4iXX0=